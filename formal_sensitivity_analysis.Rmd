---
title: "Assignment 4: LHS Sensitivity Analysis"
author: "Allie Cole, Yutian Fang, Steven Cognac"
date: "4/21/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(patchwork)
library(pse)
```

# Part 1. Code a function to compute atmoshperic conductance
```{r}
source(here("R/crop_water_use.R"))
```

# Part 2. Run the model.
```{r}
# You are estimating the atmospheric conductance for a forest that is 
# 10 m high (the accuracy of that measurement is +/- 0.5 m ) 
# Windspeeds v in this region are normally distributed with a mean of 250 cm/s 
# with a standard deviation of 30 cm/s
crop_water_use(v_m=250, h=1000)
```

# Part 3. Sensitivity Analysis

## A. Use LHS to generate parameter values for the 4 parameters

```{r}
# consider 4 parameters
factors = c("v_m", "k_d", "k_0", "h")

# calculate number of sets
nsets = 200

# choose distribution of parameters
q = c("qnorm", "qnorm", "qnorm", "qunif")
q.arg = list(list(mean=250, sd=30), 
             list(mean=0.7, sd=0.007), 
             list(mean=0.1, sd=0.001), 
             list(min=950, max=1050))

# generate samples for LHS
sens_crop_water = LHS(NULL, factors, nsets, q, q.arg)
sens_params = get.data(sens_crop_water)
head(sens_params)
```

```{r}
ggplot(sens_params, aes(x = k_0, y = k_d)) +
  geom_density_2d()
```


## B. Run atmospheric conductance model for these parameters and return aerodynamic conductances

```{r}
# lets now run our model for all of the parameters generated by LHS
crop_water = sens_params %>% 
  pmap(crop_water_use, z_m=200) %>%
  bind_rows() # turn results in to a dataframe for easy display/analysis


# tell is what links output to original LHS object
sens_conductance <- pse::tell(sens_crop_water, 
                              t(as.matrix(crop_water)),
                              res.names=c("conductance"))
```

## C. Plot conductance estimates in a way that accounts for parameter uncertainty

```{r}
hist <- ggplot(crop_water, aes(conductance)) +
  geom_histogram(fill = "firebrick4", color = "black", bins = 40) +
  labs(subtitle = "Histogram",
       x = "(cm/s)")
box <- ggplot(crop_water, aes(conductance)) +
  geom_boxplot() +
  labs(subtitle = "Boxplot",
       x = "(cm/s)") +
  coord_flip()

(hist + box) + plot_annotation(title = "LHS Atmospheric Conductance Distributions")
```

## D. Plot conductance estimates against each of your parameters

```{r}
# now we use built in LHS functions to analyze parameter sensitivity
pse::plotscatter(sens_conductance, col="blue", cex=5)
```


## Estimate Partial Rank Correlation Coefficient (PRCC)

```{r}
# partial rankk correlation coefficients
sens_conductance$prcc

# Plot PRCC with `pse`
pse::plotprcc(sens_conductance)
```

##  F. Discussion

*Discuss what your results tell you about how aerodynamic conductance varies with the different parameters? What does it suggest about what you should focus on if you want to reduce uncertainty in aerodynamic conductance estimates? Does this tell you anything about the sensitivity of plant water use to climate change?*

Our model tells us that aerodynamic conductance is the most sensitive parameter to wind speed (v_m). Wind speed has the greatest affect on aerodynamic conductance as it has the strongest correlation. It suggests that we should focus on accurate wind speed measurements if we want to reduce uncertainty in aerodynamic conductance estimates. We can infer from general science behind climate change and its potential effect on wind speeds, that the predicted increase of extreme weather events could lead to higher wind speeds which correlates to higher aerodynamic conductance. In general, this would lead to greater evapotranspiration by plants and increased stress (i.e. energy use).




```{r}
# plot empirical cumulativer distribution
plotecdf(sens_conductance, col="red", lwd=5, xlab="Atm Cond (mm/s)")
```

